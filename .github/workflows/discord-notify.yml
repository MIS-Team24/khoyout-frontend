name: Notify Discord on Push

on:
  push:
    branches:
      - dev
    paths-ignore:
      - '.github/workflows/discord-notify.yml'

jobs:
  notify:
    if: "!contains(github.event.head_commit.message, '[ci skip]')"  # Skip commits with [ci skip]
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Install jq
      run: sudo apt-get install -y jq

    - name: Load user photo URL
      id: load_photo
      run: |
        PHOTO_DATA=$(jq -r --arg user "${{ github.actor }}" '.[$user]' .github/user_photos.json)
        if [[ $PHOTO_DATA == \[ * ]]; then
          PHOTO_ARRAY=($(echo $PHOTO_DATA | jq -r '.[]'))
          RANDOM_INDEX=$((RANDOM % ${#PHOTO_ARRAY[@]}))
          PHOTO_URL=${PHOTO_ARRAY[$RANDOM_INDEX]}
        else
          PHOTO_URL=$PHOTO_DATA
        fi
        echo "PHOTO_URL=$PHOTO_URL" >> $GITHUB_ENV
        echo "Loaded photo URL: $PHOTO_URL"

    - name: Send notification to Discord
      env:
        DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        GITHUB_ACTOR: ${{ github.actor }}
        PHOTO_URL: ${{ env.PHOTO_URL }}
      run: |
        SHORT_COMMIT=$(git rev-parse --short HEAD)
        COMMIT_INFO=$(git log -1 --pretty=format:"%h - %an: %s")
        MESSAGES=("ğŸš€ Fantastic work, $GITHUB_ACTOR! ğŸš€ You've just pushed another commit: \`\`\` $COMMIT_INFO \`\`\` Keep up the great work! ğŸŒŸ We have a hard deadline on **12/6** and a graduation project demo on **13/6**. Let's push even harder to meet these goals! ğŸ’ª Check the latest updates on [our website](https://khoyout.live/). b383d90 $SHORT_COMMIT"
                  "ğŸ’¥ Amazing job, $GITHUB_ACTOR! ğŸ’¥ Another commit pushed: \`\`\` $COMMIT_INFO \`\`\` Your dedication is inspiring! ğŸŒŸ Our hard deadline is on **12/6** and the graduation project demo on **13/6**. Let's stay focused and achieve our goals! ğŸ”¥ Check the latest updates on [our website](https://khoyout.live/). b383d90 $SHORT_COMMIT"
                  "ğŸŒŸ Excellent work, $GITHUB_ACTOR! ğŸŒŸ You've committed: \`\`\` $COMMIT_INFO \`\`\` Your efforts are making a difference! We have a hard deadline on **12/6** and a demo on **13/6**. Keep pushing! ğŸ’ª Check the latest updates on [our website](https://khoyout.live/). b383d90 $SHORT_COMMIT"
                  "âœ¨ Awesome job, $GITHUB_ACTOR! âœ¨ New commit: \`\`\` $COMMIT_INFO \`\`\` Your contributions are invaluable! Our hard deadline is on **12/6** with a demo on **13/6**. Let's keep this momentum! ğŸŒŸ Check the latest updates on [our website](https://khoyout.live/). b383d90 $SHORT_COMMIT"
                  "ğŸ”¥ Incredible work, $GITHUB_ACTOR! ğŸ”¥ You've added: \`\`\` $COMMIT_INFO \`\`\` Your dedication is impressive! Let's keep this up and meet our hard deadline on **12/6** and the demo on **13/6**. Together, we're unstoppable! ğŸ’ª Check the latest updates on [our website](https://khoyout.live/). b383d90 $SHORT_COMMIT"
                  "ğŸ‰ Great job, $GITHUB_ACTOR! ğŸ‰ Another commit in the books: \`\`\` $COMMIT_INFO \`\`\` Your commitment is driving us forward! Our hard deadline is **12/6** and we have a demo on **13/6**. Let's push even harder! ğŸš€ Check the latest updates on [our website](https://khoyout.live/). b383d90 $SHORT_COMMIT"
                  "ğŸ‘ Fantastic effort, $GITHUB_ACTOR! ğŸ‘ New commit pushed: \`\`\` $COMMIT_INFO \`\`\` Your hard work is making a huge impact! Our hard deadline is on **12/6** and we have a demo on **13/6**. Keep going strong! ğŸ’ª Check the latest updates on [our website](https://khoyout.live/). b383d90 $SHORT_COMMIT"
                  "ğŸŒ  Stellar work, $GITHUB_ACTOR! ğŸŒ  Committed: \`\`\` $COMMIT_INFO \`\`\` Your dedication is shining through! Our hard deadline is on **12/6** and we have a demo on **13/6**. Let's keep the momentum! ğŸ¤˜ Check the latest updates on [our website](https://khoyout.live/). b383d90 $SHORT_COMMIT"
                  "ğŸš€ Superb job, $GITHUB_ACTOR! ğŸš€ You've pushed: \`\`\` $COMMIT_INFO \`\`\` Your efforts are pushing us forward! Our hard deadline is on **12/6** and we have a demo on **13/6**. Keep it up, champ! ğŸ’ª Check the latest updates on [our website](https://khoyout.live/). b383d90 $SHORT_COMMIT"
                  "ğŸ¯ Excellent effort, $GITHUB_ACTOR! ğŸ¯ New commit: \`\`\` $COMMIT_INFO \`\`\` Your dedication is truly appreciated! Our hard deadline is on **12/6** and we have a demo on **13/6**. Together, we can do it! ğŸš€ Check the latest updates on [our website](https://khoyout.live/). b383d90 $SHORT_COMMIT")
        RANDOM_INDEX=$((RANDOM % ${#MESSAGES[@]}))
        MOTIVATIONAL_MESSAGE=${MESSAGES[$RANDOM_INDEX]}
        PAYLOAD=$(jq -n --arg content "New push to branch \`${{ github.ref_name }}\`: $MOTIVATIONAL_MESSAGE" \
                      --arg image_url "$PHOTO_URL" \
                      '{username: "Git Bot", content: $content, embeds: [{image: {url: $image_url}}]}')
        curl -H "Content-Type: application/json" -X POST -d "$PAYLOAD" $DISCORD_WEBHOOK_URL
